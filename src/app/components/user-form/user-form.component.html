<mat-card>
  <mat-card-content>
    <form class="user-form" #userForm="ngForm" appPasswordConfirmationValidator>
      <div class="user-form__row">
        <mat-form-field class="user-form__item user-form__item-100">
          <mat-label>Nome</mat-label>
          <input
            matInput
            required
            name="nome"
            [(ngModel)]="userSelected.name"
            type="text"
          />
          <mat-error>O <strong>Nome</strong> é obrigatório</mat-error>
        </mat-form-field>
      </div>

      <div class="user-form__row">
        <mat-form-field class="user-form__item user-form__item-50">
          <mat-label>Usuário</mat-label>
          <input
            [ngModelOptions]="{ updateOn: 'blur' }"
            type="text"
            name="usuario"
            [(ngModel)]="userSelected.username"
            required
            matInput
            #userNameControl="ngModel"
            [appCredentialsValidator]="'username'"
          />
          <mat-hint
            >O <strong>usuário</strong> será utilizado para o login.</mat-hint
          >
          @if (userNameControl.hasError("required")) {
          <mat-error>O <strong>Usuário</strong> é obrigatório</mat-error>
          } @if (userNameControl.hasError('invalidUserName') &&
          !userNameControl.hasError('required')) {
          <mat-error
            >Este <strong>Usuário</strong> já está sendo utilizado.</mat-error
          >
          }
        </mat-form-field>
        <mat-form-field class="user-form__item user-form__item-50">
          <mat-label>E-mail:</mat-label>
          <input
            [ngModelOptions]="{ updateOn: 'blur' }"
            [appCredentialsValidator]="'email'"
            type="text"
            name="email"
            [(ngModel)]="userSelected.email"
            required
            matInput
            #emailControl="ngModel"
            appEmailPatternValidator
          />
          <!-- Forma mais direta de se fazer: pattern="^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$" -->
          @if (emailControl.hasError('required')) {
          <mat-error>O <strong>E-mail</strong> é obrigatório.</mat-error>
          }@if (emailControl.hasError('invalidEmailPattern') &&
          !emailControl.hasError('required')) {
          <mat-error>Formato de <strong>E-mail</strong> inválido</mat-error>
          }@if (emailControl.hasError('invalidEmail') &&
          !emailControl.hasError('required')) {
          <mat-error
            >O <strong>E-mail</strong> já esta sendo utilizado</mat-error
          >
          }
        </mat-form-field>
      </div>

      <div class="user-form__row">
        <mat-form-field class="user-form__item user-form__item-50">
          <mat-label>Senha:</mat-label>
          <input
            type="text"
            name="senha"
            matInput
            [(ngModel)]="userSelected.password"
            #passwordControl="ngModel"
            appPasswordStrengthValidator
            required
            (ngModelChange)="onPasswordChange($event)"
          />
          @if(passwordControl.hasError('required')) {
          <mat-error>A <strong>Senha</strong> é obrigatória.</mat-error>
          }@if (passwordControl?.hasError('invalidPasswordStrength') &&
          !passwordControl?.hasError('required')) {
          <mat-error>Digite uma <strong>Senha</strong> mais forte.</mat-error>
          }
          <mat-progress-bar
            [value]="passwordStrengthValue"
            [ngClass]="{
              'weak-password':
                passwordStrengthValue === 0 || passwordStrengthValue === 30,
              'medium-password': passwordStrengthValue === 60,
              'strong-password': passwordStrengthValue === 100
            }"
          ></mat-progress-bar>
        </mat-form-field>
        <mat-form-field class="user-form__item user-form__item-50">
          <mat-label>Confirmação de Senha:</mat-label>
          <input
            autocomplete="one-time-code"
            type="text"
            name="confirmacaoSenha"
            matInput
            ngModel
            #passwordConfirmationControl="ngModel"
            required
          />
          @if (passwordConfirmationControl.hasError('required')) {
          <mat-error
            >A <strong>Confirmação de Senha</strong> é obrigatória</mat-error
          >
          }
          <mat-error
            *ngIf="
              passwordConfirmationControl.hasError(
                'invalidPasswordConfirmation'
              ) && !passwordConfirmationControl.hasError('required')
            "
          >
            As <strong>Senhas</strong> estão incorretas.
          </mat-error>
        </mat-form-field>
      </div>
      <div class="user-form__row">
        <mat-form-field class="user-form__item user-form__item-50">
          <mat-label>Data de nascimento</mat-label>
          <input
            matInput
            [matDatepicker]="picker"
            [ngModel]="dateValue"
            [min]="minDate"
            [max]="maxDate"
            name="dataNascimento"
            readonly
            required
            (dateChange)="onDateChange($event)"
          />
          <mat-datepicker-toggle
            matIconSuffix
            [for]="picker"
          ></mat-datepicker-toggle>
          <mat-datepicker #picker>
            <mat-datepicker-actions>
              <button matDatepickerCancel mat-button color="warn">
                Cancelar
              </button>
              <button matDatepickerApply mat-button color="primary">
                Confirmar
              </button>
            </mat-datepicker-actions>
          </mat-datepicker>
          <mat-hint>dd/mm/aa</mat-hint>
          <mat-error
            >A <strong>Data de Nascimento</strong> é obrigatória.</mat-error
          >
        </mat-form-field>
        <mat-form-field class="user-form__item user-form__item-50">
          <mat-label>Estado:</mat-label>
          <mat-select name="estado" [(ngModel)]="userSelected.state" required>
            <mat-option>-</mat-option>
            @for (state of statesList; track $index;) {
            <mat-option [value]="state.id">{{ state.descricao }}</mat-option>
            }
          </mat-select>
          <mat-error>O <strong>Estado</strong> é obrigatório.</mat-error>
        </mat-form-field>
      </div>
      <div class="user-form__row">
        <div class="user-form__musics">
          <mat-divider></mat-divider>
          <div class="user-form__musics-title">
            <h5>Minhas músicas:</h5>
          </div>
          <table
            class="user-form__item user-form__item-100"
            mat-table
            [dataSource]="userSelected.musics"
          >
            <ng-container matColumnDef="title">
              <th mat-header-cell *matHeaderCellDef>Título</th>
              <td mat-cell *matCellDef="let element; let i = index">
                <div class="user-form__row">
                  <mat-form-field class="user-form__item">
                    <mat-label>Título</mat-label>
                    <input
                      type="text"
                      [name]="'title-' + i"
                      matInput
                      ngModel
                      required
                      [(ngModel)]="element.title"
                    />
                    <mat-error
                      >O <strong>Título</strong> é obrigatório.</mat-error
                    >
                  </mat-form-field>
                </div>
              </td>
            </ng-container>
            <ng-container matColumnDef="band">
              <th mat-header-cell *matHeaderCellDef>Banda</th>
              <td mat-cell *matCellDef="let element; let i = index">
                <div class="user-form__row">
                  <mat-form-field class="user-form__item">
                    <mat-label>Banda</mat-label>
                    <input
                      type="text"
                      [name]="'band-' + i"
                      matInput
                      ngModel
                      required
                      [(ngModel)]="element.band"
                    />
                    <mat-error
                      >A <strong>Banda</strong> é obrigatória.</mat-error
                    >
                  </mat-form-field>
                </div>
              </td>
            </ng-container>
            <ng-container matColumnDef="genre">
              <th mat-header-cell *matHeaderCellDef>Gênero</th>
              <td mat-cell *matCellDef="let element; let i = index">
                <div class="user-form__row">
                  <mat-form-field class="user-form__item">
                    <mat-label>Gênero</mat-label>
                    <input
                      type="text"
                      [name]="'genrer-' + i"
                      matInput
                      required
                      [(ngModel)]="element.genre"
                      [matAutocomplete]="auto"
                    />
                    <!-- 
                      O Angular Material espera que displayWith seja apenas uma referência de função.
                      Quando passamos "displayFn" diretamente, o contexto do "this" pode se perder
                      (o Angular chamaria a função "solta", sem saber que ela pertence ao componente).

                      Usar "displayFn.bind(this)" cria uma cópia da função já amarrada ao componente,
                      garantindo que o "this" dentro de displayFn continue apontando para a instância
                      do componente. Assim, temos acesso correto às propriedades, como this.genresList.
                    -->
                    <mat-autocomplete
                      #auto="matAutocomplete"
                      [displayWith]="displayFn.bind(this)"
                    >
                      @for (genre of genresList; track $index) {
                      <mat-option [value]="genre.id">{{
                        genre.description
                      }}</mat-option>
                      }
                    </mat-autocomplete>
                    <mat-error
                      >O <strong>Gênero</strong> é obrigatório.</mat-error
                    >
                  </mat-form-field>
                </div>
              </td>
            </ng-container>
            <ng-container matColumnDef="favorite">
              <th mat-header-cell *matHeaderCellDef>Favorita</th>
              <td mat-cell *matCellDef="let element; let i = index">
                <mat-checkbox
                  [name]="'isFavorite-' + i"
                  [(ngModel)]="element.isFavorite"
                ></mat-checkbox>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
        </div>
      </div>
    </form>
  </mat-card-content>
</mat-card>
